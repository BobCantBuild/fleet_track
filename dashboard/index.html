<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleet Track ‚Äî Executive Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/12.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnH0XEDxgUOdxmXWtA7DDJ6wg7Qpnsumk&callback=initMap" async defer></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;overflow:hidden}
    #header{background:linear-gradient(135deg,#1e3a8a,#1d4ed8);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(0,0,0,0.4);height:64px}
    #header h1{font-size:1.4rem;font-weight:700;color:#fff;display:flex;align-items:center;gap:0.5rem}
    #header-stats{display:flex;gap:1.5rem}
    .hstat{text-align:center}
    .hstat span{display:block;font-size:1.4rem;font-weight:700;color:#60a5fa}
    .hstat small{font-size:0.7rem;color:#93c5fd;text-transform:uppercase}
    #layout{display:grid;grid-template-columns:400px 1fr;height:calc(100vh - 64px)}
    #sidebar{background:#1e293b;display:flex;flex-direction:column;border-right:1px solid #334155;overflow:hidden;position:relative}
    #search-wrap{padding:0.75rem 1rem;border-bottom:1px solid #334155}
    #search{width:100%;padding:0.5rem 0.75rem;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:0.85rem;outline:none}
    #search:focus{border-color:#3b82f6}
    #franchise-tabs{display:flex;gap:0.4rem;padding:0.75rem 1rem;border-bottom:1px solid #334155;flex-wrap:wrap}
    .ftab{padding:0.3rem 0.7rem;border-radius:20px;font-size:0.72rem;cursor:pointer;border:1px solid #334155;background:transparent;color:#94a3b8;transition:all 0.2s;font-weight:500}
    .ftab:hover{border-color:#3b82f6;color:#60a5fa}
    .ftab.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
    .ftab.mfbs.active{background:#8b5cf6;border-color:#8b5cf6}
    .ftab.promptcare.active{background:#10b981;border-color:#10b981}
    .ftab.krisma.active{background:#f59e0b;border-color:#f59e0b}
    #status-tabs{display:flex;gap:0.4rem;padding:0.5rem 1rem;border-bottom:1px solid #334155}
    .stab{padding:0.25rem 0.6rem;border-radius:20px;font-size:0.72rem;cursor:pointer;border:1px solid #334155;background:transparent;color:#94a3b8;transition:all 0.2s}
    .stab.active{background:#1e3a8a;border-color:#3b82f6;color:#60a5fa}
    #tech-list{flex:1;overflow-y:auto;padding:0.5rem}
    #tech-list::-webkit-scrollbar{width:4px}
    #tech-list::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}
    .tech-card{background:#0f172a;border:1px solid #334155;border-radius:12px;padding:0.9rem 1rem;margin-bottom:0.4rem;cursor:pointer;transition:all 0.2s;border-left:4px solid #334155}
    .tech-card:hover{border-color:#3b82f6;transform:translateX(2px)}
    .tech-card.active-status{border-left-color:#22c55e}
    .tech-card.offline-status{border-left-color:#ef4444}
    .tech-card.selected{background:#1e293b;border-color:#3b82f6;border-left-color:#3b82f6}
    .tc-row{display:flex;align-items:center;gap:0.75rem}
    .tc-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;flex-shrink:0}
    .tc-info{flex:1;min-width:0}
    .tc-name{font-weight:600;font-size:0.88rem;color:#f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tc-franchise{font-size:0.72rem;color:#64748b;margin-top:1px}
    .tc-badge{font-size:0.65rem;padding:0.15rem 0.45rem;border-radius:20px;font-weight:600;flex-shrink:0}
    .tc-badge.active{background:#166534;color:#86efac}
    .tc-badge.offline{background:#7f1d1d;color:#fca5a5}
    .tc-stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.6rem}
    .tc-stat{background:#1e293b;border-radius:6px;padding:0.35rem;text-align:center}
    .tc-stat span{display:block;font-size:0.82rem;font-weight:700;color:#60a5fa}
    .tc-stat small{font-size:0.62rem;color:#64748b;text-transform:uppercase}

    /* Detail panel */
    #detail-panel{position:absolute;bottom:0;left:0;width:100%;background:#1e293b;border-top:2px solid #3b82f6;z-index:20;max-height:65vh;display:none;flex-direction:column;border-radius:16px 16px 0 0;box-shadow:0 -10px 40px rgba(0,0,0,0.5)}
    #detail-panel.open{display:flex}
    #dp-header{padding:1rem 1.25rem 0.75rem;border-bottom:1px solid #334155;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    #dp-name{font-weight:700;font-size:0.95rem;color:#f1f5f9}
    #dp-franchise{font-size:0.75rem;color:#64748b;margin-top:2px}
    #dp-close{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:1.3rem;line-height:1;padding:0.2rem 0.4rem;border-radius:6px}
    #dp-close:hover{background:#334155;color:#f1f5f9}
    #dp-body{overflow-y:auto;padding:1rem 1.25rem 1.5rem;flex:1}
    #dp-body::-webkit-scrollbar{width:4px}
    #dp-body::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}

    /* Session timeline */
    .session-timeline{position:relative;padding-left:1.5rem;margin-bottom:1.25rem}
    .session-timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,#22c55e,#ef4444,#22c55e,#ef4444)}
    .session-node{position:relative;margin-bottom:0.5rem}
    .session-node::before{content:'';position:absolute;left:-1.5rem;top:50%;transform:translateY(-50%);width:12px;height:12px;border-radius:50%;border:2px solid #1e293b;z-index:1}
    .session-node.punch-in::before{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.6)}
    .session-node.punch-out::before{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.6)}
    .session-node.active-now::before{background:#22c55e;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 4px rgba(34,197,94,0.4)}50%{box-shadow:0 0 14px rgba(34,197,94,0.9)}}
    .session-box{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:0.6rem 0.85rem;display:flex;align-items:center;justify-content:space-between}
    .session-box.in-box{border-left:3px solid #22c55e}
    .session-box.out-box{border-left:3px solid #ef4444}
    .session-box.active-box{border-left:3px solid #22c55e;background:#052e16}
    .sb-type{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em}
    .sb-type.in{color:#22c55e}
    .sb-type.out{color:#ef4444}
    .sb-type.now{color:#22c55e;animation:pulse-text 1.5s infinite}
    @keyframes pulse-text{0%,100%{opacity:1}50%{opacity:0.5}}
    .sb-time{font-size:0.95rem;font-weight:700;color:#f1f5f9;margin-top:2px}
    .sb-km{font-size:0.78rem;font-weight:600;color:#60a5fa}
    .sb-dur{font-size:0.68rem;color:#64748b;margin-top:2px}
    .session-count-badge{font-size:0.72rem;color:#64748b;margin-bottom:0.75rem;padding:0.3rem 0.75rem;background:#0f172a;border-radius:6px;display:inline-block;border:1px solid #334155}

    /* Movement timeline */
    .section-title{font-size:0.72rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;font-weight:600}
    .timeline{position:relative;padding-left:1.5rem}
    .timeline::before{content:'';position:absolute;left:6px;top:4px;bottom:4px;width:2px;background:linear-gradient(to bottom,#3b82f6,#1e3a8a)}
    .tl-item{position:relative;margin-bottom:0.5rem;padding:0.55rem 0.75rem;background:#0f172a;border-radius:10px;border:1px solid #334155;transition:border-color 0.2s}
    .tl-item:hover{border-color:#3b82f6}
    .tl-item::before{content:'';position:absolute;left:-1.5rem;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:#3b82f6;border:2px solid #1e293b;box-shadow:0 0 6px rgba(59,130,246,0.5)}
    .tl-item:first-child::before{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.6)}
    .tl-time{font-size:0.72rem;color:#94a3b8;font-weight:600}
    .tl-coords{font-size:0.78rem;color:#cbd5e1;margin-top:3px}
    .tl-km{font-size:0.72rem;color:#60a5fa;margin-top:3px;font-weight:600}

    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 1rem;color:#475569;text-align:center}
    .empty-state .icon{font-size:2.5rem;margin-bottom:0.75rem}
    #map-wrap{position:relative}
    #map{width:100%;height:100%}
    #map-overlay{position:absolute;top:1rem;right:1rem;background:rgba(30,41,59,0.95);border-radius:12px;padding:0.75rem 1rem;border:1px solid #334155;z-index:5;min-width:180px;backdrop-filter:blur(10px)}
    #map-overlay h3{font-size:0.7rem;color:#94a3b8;margin-bottom:0.4rem;text-transform:uppercase;letter-spacing:0.05em}
    @media(max-width:768px){body{overflow:auto}#layout{grid-template-columns:1fr;grid-template-rows:auto 50vh}#header-stats{display:none}#detail-panel{width:100%}}
  </style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <h1>üöõ Fleet Track Dashboard</h1>
  <div id="header-stats">
    <div class="hstat"><span id="active-count">0</span><small>Active</small></div>
    <div class="hstat"><span id="total-count">0</span><small>Total</small></div>
    <div class="hstat"><span id="total-km">0</span><small>km Today</small></div>
    <div class="hstat"><span id="last-updated">--:--</span><small>Updated</small></div>
  </div>
</div>

<div id="layout">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="search-wrap">
      <input id="search" type="text" placeholder="üîç Search technician..." oninput="renderSidebar()"/>
    </div>
    <div id="franchise-tabs">
      <button class="ftab active"     onclick="setFranchise('all',this)">All</button>
      <button class="ftab mfbs"       onclick="setFranchise('MFBS',this)">MFBS</button>
      <button class="ftab promptcare" onclick="setFranchise('PromptCare',this)">PromptCare</button>
      <button class="ftab krisma"     onclick="setFranchise('Krisma Tech',this)">Krisma Tech</button>
    </div>
    <div id="status-tabs">
      <button class="stab active" onclick="setStatus('all',this)">All</button>
      <button class="stab"        onclick="setStatus('active',this)">üü¢ Live</button>
      <button class="stab"        onclick="setStatus('offline',this)">üî¥ Offline</button>
    </div>
    <div id="tech-list"></div>

    <!-- DETAIL PANEL -->
    <div id="detail-panel">
      <div id="dp-header">
        <div>
          <div id="dp-name">Technician</div>
          <div id="dp-franchise"></div>
        </div>
        <button id="dp-close" onclick="closeDetail()">‚úï</button>
      </div>
      <div id="dp-body">
        <div class="section-title">‚è± Punch History</div>
        <div id="dp-session-count" class="session-count-badge">Loading...</div>
        <div class="session-timeline" id="dp-sessions"></div>
        <div class="section-title">üìç Movement History</div>
        <div class="timeline" id="dp-timeline"></div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map-wrap">
    <div id="map"></div>
    <div id="map-overlay">
      <h3>Live Map</h3>
      <div id="overlay-info" style="font-size:0.78rem;color:#94a3b8">Click a card to focus</div>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const firebaseConfig = {
    apiKey:            "AIzaSyDb2ro59qZ20XYMCydndpMXgeRJ6HmaEoQ",
    authDomain:        "fleet-track-486de.firebaseapp.com",
    projectId:         "fleet-track-486de",
    storageBucket:     "fleet-track-486de.firebasestorage.app",
    messagingSenderId: "778334362913",
    appId:             "1:778334362913:web:a44beb20a97af383043260"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let map, markers = {}, infoWindows = {};
  let techData = {}, franchiseFilter = 'all', statusFilter = 'all';
  let selectedTechId = null, trailUnsub = null;

  const fColors = {
    'MFBS':       '#8b5cf6',
    'PromptCare': '#10b981',
    'Krisma Tech':'#f59e0b',
  };
  const aColors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981','#06b6d4','#f97316','#84cc16'];
  const aColor  = f => fColors[f] || aColors[(f||'?').charCodeAt(0) % aColors.length];

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function formatTime(date) {
    if (!date) return '0';
    return date.toLocaleTimeString('en-IN', {
      hour: '2-digit', minute: '2-digit', hour12: true
    });
  }
  function formatDate(date) {
    if (!date) return '';
    return date.toLocaleDateString('en-IN', {day: '2-digit', month: 'short'});
  }
  function duration(start, end) {
    if (!start || !end) return '';
    const diff = Math.floor((end - start) / 1000);
    const h    = Math.floor(diff / 3600);
    const m    = Math.floor((diff % 3600) / 60);
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  }
  function timeAgo(date) {
    if (!date) return '--';
    const s = Math.floor((new Date() - date) / 1000);
    if (s < 60)   return s + 's';
    if (s < 3600) return Math.floor(s / 60) + 'm';
    return Math.floor(s / 3600) + 'h';
  }

  // ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: {lat: 8.6, lng: 76.9},
      styles: [
        {elementType:'geometry',           stylers:[{color:'#1a2332'}]},
        {elementType:'labels.text.stroke', stylers:[{color:'#242f3e'}]},
        {elementType:'labels.text.fill',   stylers:[{color:'#746855'}]},
        {featureType:'road',elementType:'geometry',         stylers:[{color:'#2c3e50'}]},
        {featureType:'road',elementType:'labels.text.fill', stylers:[{color:'#9ca5b3'}]},
        {featureType:'water',elementType:'geometry',        stylers:[{color:'#17263c'}]},
        {featureType:'poi',                stylers:[{visibility:'off'}]},
      ]
    });
    startTracking();
  }

  // ‚îÄ‚îÄ LIVE LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function startTracking() {
    db.collection('locations').onSnapshot(snap => {
      techData = {};
      snap.forEach(doc => { techData[doc.id] = {id: doc.id, ...doc.data()}; });
      renderSidebar();
      renderMarkers();
      updateHeader();
    });
  }

  // ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSidebar() {
    const list   = document.getElementById('tech-list');
    const search = document.getElementById('search').value.toLowerCase();
    list.innerHTML = '';

    const sorted = Object.values(techData).sort((a, b) => {
      if (a.status === 'active' && b.status !== 'active') return -1;
      if (a.status !== 'active' && b.status === 'active') return  1;
      return (a.name || '').localeCompare(b.name || '');
    });

    let count = 0;
    sorted.forEach(tech => {
      const isActive = tech.status === 'active';
      if (franchiseFilter !== 'all' && tech.franchise !== franchiseFilter) return;
      if (statusFilter === 'active'  && !isActive) return;
      if (statusFilter === 'offline' &&  isActive) return;
      if (search && !`${tech.name} ${tech.franchise}`.toLowerCase().includes(search)) return;
      count++;
      list.appendChild(buildCard(tech, isActive));
    });

    if (count === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="icon">üöõ</div>
          <div>No technicians found</div>
          <small style="margin-top:4px;display:block">Waiting for Punch IN...</small>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildCard(tech, isActive) {
    const div      = document.createElement('div');
    const initials = (tech.name||'?').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const bg       = aColor(tech.franchise);
    const km       = (tech.totalKm || 0).toFixed(1);
    const spd      = ((tech.speed  || 0) * 3.6).toFixed(0);
    const upd      = tech.updatedAt?.toDate ? timeAgo(tech.updatedAt.toDate()) : '--';

    div.className = `tech-card ${isActive?'active-status':'offline-status'} ${tech.id===selectedTechId?'selected':''}`;
    div.innerHTML = `
      <div class="tc-row">
        <div class="tc-avatar" style="background:${bg}">${initials}</div>
        <div class="tc-info">
          <div class="tc-name">${tech.name||'Unknown'}</div>
          <div class="tc-franchise">${tech.franchise||''}</div>
        </div>
        <span class="tc-badge ${isActive?'active':'offline'}">${isActive?'‚óè LIVE':'‚óè OFF'}</span>
      </div>
      <div class="tc-stats-row">
        <div class="tc-stat"><span>${km}</span><small>km</small></div>
        <div class="tc-stat"><span>${spd}</span><small>km/h</small></div>
        <div class="tc-stat"><span>${upd}</span><small>updated</small></div>
      </div>`;
    div.onclick = () => openDetail(tech.id);
    return div;
  }

  // ‚îÄ‚îÄ OPEN DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function openDetail(techId) {
    selectedTechId = techId;
    renderSidebar();

    const tech = techData[techId];
    if (!tech) return;

    // Map focus
    if (tech.lat && tech.lng) {
      map.panTo({lat: tech.lat, lng: tech.lng});
      map.setZoom(16);
      Object.values(infoWindows).forEach(iw => iw.close());
      infoWindows[techId]?.open(map, markers[techId]);
    }

    // Overlay
    document.getElementById('overlay-info').innerHTML = `
      <strong style="color:#f1f5f9">${tech.name}</strong><br>
      <span style="color:#94a3b8">${tech.franchise}</span><br>
      <span style="color:#60a5fa">üõ£Ô∏è ${(tech.totalKm||0).toFixed(1)} km</span>`;

    // Panel
    document.getElementById('dp-name').textContent         = tech.name || 'Unknown';
    document.getElementById('dp-franchise').textContent    = tech.franchise || '';
    document.getElementById('dp-session-count').textContent = 'Loading...';
    document.getElementById('dp-sessions').innerHTML       =
      '<div style="color:#64748b;font-size:0.85rem">Loading sessions...</div>';
    document.getElementById('dp-timeline').innerHTML       =
      '<div style="color:#64748b;font-size:0.85rem">Loading history...</div>';
    document.getElementById('detail-panel').classList.add('open');

    // ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    try {
      const snap = await db.collection('sessions')
        .where('techId', '==', techId)
        .get();

      const sessions = [];
      snap.forEach(doc => sessions.push(doc.data()));

      // Sort oldest ‚Üí newest (top to bottom like GitHub commits)
      sessions.sort((a, b) => {
        const ta = a.punchIn?.toDate?.() || new Date(0);
        const tb = b.punchIn?.toDate?.() || new Date(0);
        return ta - tb;
      });

      const container = document.getElementById('dp-sessions');
      const countEl   = document.getElementById('dp-session-count');
      container.innerHTML = '';

      if (sessions.length === 0) {
        countEl.textContent    = '0 sessions';
        container.innerHTML    =
          '<div style="color:#64748b;font-size:0.85rem;padding:0.5rem 0">No sessions recorded yet.</div>';
      } else {
        countEl.textContent = `${sessions.length} session${sessions.length > 1 ? 's' : ''}`;

        sessions.forEach((s, i) => {
          const pIn    = s.punchIn?.toDate?.();
          const pOut   = s.punchOut?.toDate?.();
          const isLast = i === sessions.length - 1;
          const isNow  = !pOut && isLast;

          // ‚îÄ‚îÄ Punch IN node ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const inNode = document.createElement('div');
          inNode.className = `session-node punch-in${isNow ? ' active-now' : ''}`;
          inNode.innerHTML = `
            <div class="session-box in-box${isNow ? ' active-box' : ''}">
              <div>
                <div class="sb-type in${isNow ? ' now' : ''}">
                  ${isNow ? '‚óè LIVE NOW' : `‚ñ∂ Punch IN ‚Äî Session ${i + 1}`}
                </div>
                <div class="sb-time">${pIn ? formatTime(pIn) : '0'}</div>
              </div>
              <div style="text-align:right">
                <div class="sb-km">üõ£Ô∏è ${(s.totalKm || 0).toFixed(1)} km</div>
                <div class="sb-dur">${pIn ? formatDate(pIn) : ''}</div>
              </div>
            </div>`;
          container.appendChild(inNode);

          // ‚îÄ‚îÄ Punch OUT node ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const outNode = document.createElement('div');
          outNode.className = 'session-node punch-out';
          outNode.innerHTML = `
            <div class="session-box out-box">
              <div>
                <div class="sb-type out">‚ñ† Punch OUT ‚Äî Session ${i + 1}</div>
                <div class="sb-time">${pOut ? formatTime(pOut) : isNow ? '‚Äî' : '0'}</div>
              </div>
              <div style="text-align:right">
                <div class="sb-dur">${pIn && pOut ? duration(pIn, pOut) : isNow ? 'Active' : ''}</div>
              </div>
            </div>`;
          container.appendChild(outNode);
        });
      }
    } catch (e) {
      document.getElementById('dp-sessions').innerHTML =
        '<div style="color:#ef4444;font-size:0.85rem">Could not load sessions.</div>';
    }

    loadTrail(techId);
  }

  // ‚îÄ‚îÄ TRAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadTrail(techId) {
    if (trailUnsub) { trailUnsub(); trailUnsub = null; }
    const timeline = document.getElementById('dp-timeline');

    const render = docs => {
      if (docs.length === 0) {
        timeline.innerHTML =
          '<div style="color:#64748b;font-size:0.85rem">No movement recorded yet.</div>';
        return;
      }
      timeline.innerHTML = '';
      docs.forEach(d => {
        const ts  = d.timestamp?.toDate ? formatTime(d.timestamp.toDate()) : '--';
        const lat = d.lat?.toFixed(5) || '--';
        const lng = d.lng?.toFixed(5) || '--';
        const km  = (d.totalKm || 0).toFixed(2);
        const el  = document.createElement('div');
        el.className = 'tl-item';
        el.innerHTML = `
          <div class="tl-time">üïê ${ts}</div>
          <div class="tl-coords">üìç ${lat}¬∞, ${lng}¬∞</div>
          <div class="tl-km">üõ£Ô∏è ${km} km cumulative</div>`;
        timeline.appendChild(el);
      });
    };

    // Try ordered query first; fallback to client-side sort if index missing
    trailUnsub = db
      .collection('locations').doc(techId)
      .collection('trail')
      .orderBy('timestamp', 'desc')
      .limit(30)
      .onSnapshot(
        snap => {
          const docs = [];
          snap.forEach(d => docs.push(d.data()));
          render(docs);
        },
        () => {
          // Fallback: no index ‚Äî sort client-side
          db.collection('locations').doc(techId)
            .collection('trail').limit(30).get()
            .then(snap => {
              const docs = [];
              snap.forEach(d => docs.push(d.data()));
              docs.sort((a, b) => {
                const ta = a.timestamp?.toDate?.() || new Date(0);
                const tb = b.timestamp?.toDate?.() || new Date(0);
                return tb - ta;
              });
              render(docs);
            });
        }
      );
  }

  // ‚îÄ‚îÄ CLOSE DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function closeDetail() {
    document.getElementById('detail-panel').classList.remove('open');
    if (trailUnsub) { trailUnsub(); trailUnsub = null; }
    selectedTechId = null;
    document.getElementById('overlay-info').textContent = 'Click a card to focus';
    renderSidebar();
  }

  // ‚îÄ‚îÄ MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderMarkers() {
    Object.values(markers).forEach(m => m.setMap(null));
    Object.values(infoWindows).forEach(iw => iw.close());
    markers = {}; infoWindows = {};

    const bounds = new google.maps.LatLngBounds();
    let hasBounds = false;

    Object.values(techData).forEach(tech => {
      if (!tech.lat || !tech.lng) return;
      const isActive = tech.status === 'active';
      const bg       = aColor(tech.franchise);
      const initial  = (tech.name || '?').charAt(0).toUpperCase();
      const km       = (tech.totalKm || 0).toFixed(1);

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="42" height="50" viewBox="0 0 42 50">
          <circle cx="21" cy="19" r="18" fill="${isActive ? bg : '#6b7280'}"
                  stroke="#ffffff" stroke-width="2.5"/>
          <polygon points="13,35 29,35 21,48" fill="${isActive ? bg : '#6b7280'}"/>
          <text x="21" y="25" text-anchor="middle" fill="white"
                font-size="14" font-family="Arial" font-weight="bold">${initial}</text>
        </svg>`;

      const marker = new google.maps.Marker({
        position: {lat: tech.lat, lng: tech.lng},
        map,
        title: tech.name,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
          scaledSize: new google.maps.Size(42, 50),
          anchor:     new google.maps.Point(21, 48),
        },
        zIndex: isActive ? 10 : 1,
      });

      const iw = new google.maps.InfoWindow({
        content: `
          <div style="font-family:sans-serif;padding:4px;min-width:160px">
            <strong>${tech.name || 'Unknown'}</strong><br>
            <span style="color:#666;font-size:0.85rem">${tech.franchise || ''}</span><br><br>
            <div>üìç ${tech.lat.toFixed(4)}¬∞, ${tech.lng.toFixed(4)}¬∞</div>
            <div>üõ£Ô∏è ${km} km</div>
            <div>‚ö° ${((tech.speed || 0) * 3.6).toFixed(0)} km/h</div>
            <div style="color:${isActive ? '#16a34a' : '#dc2626'};font-weight:bold;margin-top:4px">
              ${isActive ? 'üü¢ LIVE' : 'üî¥ Offline'}
            </div>
          </div>`,
      });

      marker.addListener('click', () => {
        Object.values(infoWindows).forEach(i => i.close());
        iw.open(map, marker);
        openDetail(tech.id);
      });

      markers[tech.id]     = marker;
      infoWindows[tech.id] = iw;
      bounds.extend({lat: tech.lat, lng: tech.lng});
      hasBounds = true;
    });

    if (hasBounds && !selectedTechId) map.fitBounds(bounds);
  }

  // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateHeader() {
    const all    = Object.values(techData);
    const active = all.filter(t => t.status === 'active');
    const km     = all.reduce((s, t) => s + (t.totalKm || 0), 0);
    document.getElementById('active-count').textContent = active.length;
    document.getElementById('total-count').textContent  = all.length;
    document.getElementById('total-km').textContent     = km.toFixed(1);
    document.getElementById('last-updated').textContent =
      new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', hour12:true});
  }

  // ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setFranchise(val, el) {
    franchiseFilter = val;
    document.querySelectorAll('#franchise-tabs .ftab').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    renderSidebar();
  }
  function setStatus(val, el) {
    statusFilter = val;
    document.querySelectorAll('#status-tabs .stab').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    renderSidebar();
  }

  setInterval(updateHeader, 30000);
</script>
</body>
</html>
